name: üåê Daily Publish

on:
  schedule:
    - cron: '45 11 * * *'  # 14:45 TR (11:45 UTC)
  workflow_dispatch:

jobs:
  setup-and-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 saat ‚Äî podcast i√ßin yeterli
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libgl1 libglib2.0-0 libsm6 libxrender1 libxext6 libfontconfig1 libfreetype6

      - name: Install ImageMagick (for TextClip)
        run: |
          sudo apt-get install -y imagemagick
          convert -version

      - name: Cleanup disk space
        run: |
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android

      - name: Install Ollama
        run: curl -fsSL https://ollama.com/install.sh | sh

      - name: Start Ollama API manually
        run: |
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 5
          
          # API hazƒ±r olana kadar bekle
          timeout 60s bash -c '
            while ! curl -sf http://localhost:11434; do
              echo "‚è≥ Waiting for Ollama API..."
              sleep 5
            done
          '
          
          echo "‚úÖ Ollama API ready"

      - name: Pull and verify models
        run: |
         
          rm -rf ~/.ollama/models/blobs/* || true
          
          
          ollama pull qwen2
          ollama pull phi3
          ollama pull llama3.2
          
         
          ollama list
          
         
          timeout 60s ollama run qwen2 "Hello" >/dev/null && echo "‚úÖ qwen2 OK" || echo "‚ö†Ô∏è qwen2 failed"
          timeout 60s ollama run phi3 "Hello" >/dev/null && echo "‚úÖ phi3 OK" || echo "‚ö†Ô∏è phi3 failed"
          timeout 60s ollama run llama3.2 "Hello" >/dev/null && echo "‚úÖ llama3.2 OK" || echo "‚ö†Ô∏è llama3.2 failed"
          
         
          echo "‚ÑπÔ∏è Pipeline working.."

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Run Shorts Pipeline
        run: python run_pipeline.py --mode shorts
        env:
          YOUTUBE_TOKEN_ENCODED: ${{ secrets.YOUTUBE_TOKEN_ENCODED }}

      - name: Run Podcast Pipeline
        run: python run_pipeline.py --mode podcast
        env:
          YOUTUBE_TOKEN_ENCODED: ${{ secrets.YOUTUBE_TOKEN_ENCODED }}
